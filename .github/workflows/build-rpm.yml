name: Build RPM

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install RPM tools
        run: sudo apt-get update && sudo apt-get install -y rpm gettext

      - name: Get version
        id: version
        run: echo "version=$(grep -oP 'version = "\K[^"]+' pyproject.toml)" >> $GITHUB_OUTPUT

      - name: Compile translations
        run: |
          for po in po/*.po; do
            [ -f "$po" ] || continue
            lang=$(basename "$po" .po)
            mkdir -p locale/$lang/LC_MESSAGES
            msgfmt -o locale/$lang/LC_MESSAGES/ubuntu-l10n.mo "$po"
          done

      - name: Setup RPM build
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          VERSION=${{ steps.version.outputs.version }}
          PKG=ubuntu-l10n-$VERSION
          mkdir -p $PKG/ubuntu_l10n
          cp ubuntu_l10n/*.py $PKG/ubuntu_l10n/
          cp ubuntu_l10n/*.desktop $PKG/ 2>/dev/null || true
          cp data/*.desktop $PKG/ 2>/dev/null || true
          cp ubuntu_l10n/*.svg $PKG/ 2>/dev/null || true
          cp data/icons/*.svg $PKG/ 2>/dev/null || true
          [ -f LICENSE ] && cp LICENSE $PKG/
          if [ -d locale ]; then cp -r locale $PKG/; fi
          tar czf ~/rpmbuild/SOURCES/ubuntu-l10n-$VERSION.tar.gz $PKG

      - name: Create spec and build
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cat > ~/rpmbuild/SPECS/ubuntu-l10n.spec << 'SPEC'
Name:           ubuntu-l10n
Version:        VERSION_PLACEHOLDER
Release:        1
Summary:        Ubuntu/Launchpad translation statistics viewer
License:        GPL-3.0-or-later
URL:            https://github.com/yeager/ubuntu-l10n
Source0:        %{name}-%{version}.tar.gz
BuildArch:      noarch
Requires:       python3 >= 3.9, python3-gobject, python3-requests, python3-beautifulsoup4, gtk4, libadwaita

%description
GTK4/Adwaita application for viewing Ubuntu/Launchpad translation statistics.

%prep
%setup -q

%install
mkdir -p %{buildroot}%{_datadir}/ubuntu-l10n
cp ubuntu_l10n/*.py %{buildroot}%{_datadir}/ubuntu-l10n/
mkdir -p %{buildroot}%{_bindir}
cat > %{buildroot}%{_bindir}/ubuntu-l10n << 'WRAPPER'
#!/bin/bash
exec python3 %{_datadir}/ubuntu-l10n/app.py "$@"
WRAPPER
chmod 755 %{buildroot}%{_bindir}/ubuntu-l10n
install -Dm644 *.desktop %{buildroot}%{_datadir}/applications/se.danielnylander.ubuntu-l10n.desktop 2>/dev/null || true
install -Dm644 *.svg %{buildroot}%{_datadir}/icons/hicolor/scalable/apps/se.danielnylander.ubuntu-l10n.svg 2>/dev/null || true

if [ -d locale ]; then
  for mo in locale/*/LC_MESSAGES/*.mo; do
    [ -f "$mo" ] || continue
    lang=$(echo "$mo" | cut -d/ -f2)
    install -Dm644 "$mo" "%{buildroot}%{_datadir}/locale/$lang/LC_MESSAGES/ubuntu-l10n.mo"
  done
fi

%files
%{_bindir}/ubuntu-l10n
%{_datadir}/ubuntu-l10n/
%{_datadir}/applications/se.danielnylander.ubuntu-l10n.desktop
%{_datadir}/icons/hicolor/scalable/apps/se.danielnylander.ubuntu-l10n.svg

%changelog
SPEC
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/" ~/rpmbuild/SPECS/ubuntu-l10n.spec
          rpmbuild -ba ~/rpmbuild/SPECS/ubuntu-l10n.spec

      - name: Upload RPM to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ github.event.release.tag_name || github.ref_name }}
          VERSION=${{ steps.version.outputs.version }}
          RPM=~/rpmbuild/RPMS/noarch/ubuntu-l10n-${VERSION}-1.noarch.rpm
          [ -f "$RPM" ] && gh release upload "$TAG" "$RPM" --clobber || echo "No RPM or no release"
